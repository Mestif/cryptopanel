#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è DMG —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è

set -e

PROJECT_NAME="CryptoPanelApp"
APP_NAME="CryptoPanelApp.app"
DMG_NAME="CryptoPanel"
VERSION="1.9.0"
BUILD_DIR="build"
DMG_DIR="dmg_build"
DMG_FILE="${DMG_NAME}_v${VERSION}.dmg"

echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ DMG —Ñ–∞–π–ª–∞ –¥–ª—è $PROJECT_NAME..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ
if [ ! -d "$BUILD_DIR/$APP_NAME" ]; then
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./build.sh"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è DMG
echo "üìÅ –°–æ–∑–¥–∞—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
rm -rf "$DMG_DIR"
mkdir -p "$DMG_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üìã –ö–æ–ø–∏—Ä—É—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
cp -R "$BUILD_DIR/$APP_NAME" "$DMG_DIR/"

# –£–¥–∞–ª—è–µ–º quarantine –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –æ–±—Ö–æ–¥–∞ Gatekeeper
echo "üîì –£–¥–∞–ª—è—é quarantine –∞—Ç—Ä–∏–±—É—Ç..."
xattr -cr "$DMG_DIR/$APP_NAME" 2>/dev/null || true

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ Applications
echo "üîó –°–æ–∑–¥–∞—é —Å—Å—ã–ª–∫—É –Ω–∞ Applications..."
ln -s /Applications "$DMG_DIR/Applications"

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ DMG
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é DMG..."

# –°–æ–∑–¥–∞–µ–º DMG —Ñ–∞–π–ª
echo "üíø –°–æ–∑–¥–∞—é DMG —Ñ–∞–π–ª..."
hdiutil create -srcfolder "$DMG_DIR" \
    -volname "$DMG_NAME" \
    -fs HFS+ \
    -fsargs "-c c=64,a=16,e=16" \
    -format UDRW \
    -size 10m \
    "${DMG_FILE}.temp.dmg" || {
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è DMG"
    exit 1
}

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥ DMG (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
echo "üìê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –≤–∏–¥ DMG..."
sleep 1

# –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥ —á–µ—Ä–µ–∑ AppleScript
VOLUME_NAME="CryptoPanel"
osascript -e "tell application \"Finder\" to close window \"$VOLUME_NAME\"" 2>/dev/null || true

# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–∏–¥–∞ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é)
echo "‚ÑπÔ∏è  DMG —Å–æ–∑–¥–∞–Ω. –í–∏–¥ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."

# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å–∂–∞—Ç—ã–π, —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
echo "üóúÔ∏è  –°–∂–∏–º–∞—é DMG..."
hdiutil convert "${DMG_FILE}.temp.dmg" \
    -format UDZO \
    -imagekey zlib-level=9 \
    -o "$DMG_FILE" || {
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è DMG"
    exit 1
}

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "${DMG_FILE}.temp.dmg"

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
rm -rf "$DMG_DIR"

echo ""
echo "‚úÖ DMG —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
echo "üì¶ –§–∞–π–ª: $DMG_FILE"
echo "üìä –†–∞–∑–º–µ—Ä: $(du -h "$DMG_FILE" | cut -f1)"
echo ""
echo "–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é! üéâ"

